rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──

    function isAuthenticated() {
      return request.auth != null;
    }

    function getMember() {
      return get(/databases/$(database)/documents/members/$(request.auth.uid));
    }

    function hasRole(role) {
      return isAuthenticated() && role in getMember().data.roles;
    }

    function hasAnyRole(roles) {
      return isAuthenticated() && getMember().data.roles.hasAny(roles);
    }

    function isWebAdmin() {
      return hasRole('web_admin');
    }

    function isBoard() {
      return hasAnyRole(['web_admin', 'club_board']);
    }

    function isRCChair() {
      return hasAnyRole(['web_admin', 'rc_chair']);
    }

    function isSkipperOrAbove() {
      return hasAnyRole(['web_admin', 'rc_chair', 'club_board', 'skipper']);
    }

    function isOwnDocument(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ── Members ──
    match /members/{memberId} {
      allow read: if isAuthenticated();
      allow write: if isWebAdmin();
      allow update: if isOwnDocument(memberId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles']);
    }

    // ── Race Events ──
    match /race_events/{eventId} {
      allow read: if isAuthenticated();
      allow create, delete: if hasAnyRole(['web_admin', 'rc_chair']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Season Series ──
    match /season_series/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Courses ──
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isWebAdmin();
    }

    // ── Marks and Mark Distances ──
    match /marks/{markId} {
      allow read: if isAuthenticated();
      allow write: if isWebAdmin();
    }
    match /mark_distances/{distId} {
      allow read: if isAuthenticated();
      allow write: if isWebAdmin();
    }

    // ── Checklists (templates) ──
    match /checklists/{checklistId} {
      allow read: if isAuthenticated();
      allow write: if isWebAdmin();
    }

    // ── Checklist Completions ──
    match /checklist_completions/{completionId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['web_admin', 'rc_chair']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair'])
        || (isAuthenticated() && resource.data.completedBy == request.auth.uid);
    }

    // ── Maintenance Requests ──
    match /maintenance_requests/{requestId} {
      allow read: if hasAnyRole(['web_admin', 'club_board', 'rc_chair', 'skipper']);
      allow create: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow update: if isWebAdmin()
        || (isRCChair() && resource.data.reportedBy == request.auth.uid);
      allow delete: if isWebAdmin();
    }

    // ── Scheduled Maintenance ──
    match /scheduled_maintenance/{docId} {
      allow read: if hasAnyRole(['web_admin', 'club_board', 'rc_chair']);
      allow write: if isWebAdmin();
    }

    // ── Race Incidents ──
    match /incidents/{incidentId} {
      allow read: if hasAnyRole(['web_admin', 'club_board', 'rc_chair'])
        || (isAuthenticated() && request.auth.uid in resource.data.involvedMemberIds);
      allow create: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Boat Check-ins ──
    match /boat_checkins/{checkinId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair'])
        || (isAuthenticated() && resource.data.checkedInBy == request.auth.uid);
    }

    // ── Weather (live station data — written by Cloud Functions only) ──
    match /weather/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ── Weather Logs (manual entries) ──
    match /weather_logs/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Fleet Broadcasts ──
    match /fleet_broadcasts/{broadcastId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    match /fleetBroadcasts/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ── Timing ──
    match /timing/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Audit Log ──
    match /audit_logs/{logId} {
      allow read: if isBoard();
      allow create: if false;
    }

    // ── Reports ──
    match /reports/{reportId} {
      allow read: if isBoard();
      allow write: if isWebAdmin();
    }

    // ── Verification codes: Cloud Functions only ──
    match /verification_codes/{docId} {
      allow read, write: if false;
    }

    // ── Mail queue: Cloud Functions only ──
    match /mail/{docId} {
      allow read, write: if false;
    }

    // ── Sync logs: admin-only reads ──
    match /memberSyncLogs/{docId} {
      allow read: if isWebAdmin();
      allow write: if false;
    }

    // ── Admin notifications: admin-only reads ──
    match /adminNotifications/{docId} {
      allow read: if isWebAdmin();
      allow write: if false;
    }

    // ── SMS logs: admin-only reads ──
    match /smsLogs/{docId} {
      allow read: if isWebAdmin();
      allow write: if false;
    }

    // ── Default deny ──
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
