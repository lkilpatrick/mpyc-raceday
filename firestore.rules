rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──

    function isAuthenticated() {
      return request.auth != null;
    }

    function getMember() {
      return get(/databases/$(database)/documents/members/$(request.auth.uid));
    }

    function hasRole(role) {
      return isAuthenticated() && role in getMember().data.roles;
    }

    function hasAnyRole(roles) {
      return isAuthenticated() && getMember().data.roles.hasAny(roles);
    }

    function isWebAdmin() {
      return hasRole('web_admin');
    }

    function isBoard() {
      return hasAnyRole(['web_admin', 'club_board']);
    }

    function isRCChair() {
      return hasAnyRole(['web_admin', 'rc_chair']);
    }


    function isOwnDocument(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ── Members ──
    match /members/{memberId} {
      allow read: if isAuthenticated();
      // Allow users to create/update their own UID-keyed doc (for rules lookup)
      allow create: if isAuthenticated() && request.auth.uid == memberId;
      allow update: if isOwnDocument(memberId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles']);
      // Full CRUD for admins (including delete)
      allow read, create, update, delete: if isWebAdmin();
    }

    // ── Race Events ──
    match /race_events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow delete: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Season Series ──
    match /season_series/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Courses ──
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isRCChair();
    }

    // ── Marks and Mark Distances ──
    match /marks/{markId} {
      allow read: if isAuthenticated();
      allow write: if isRCChair();
    }
    match /mark_distances/{distId} {
      allow read: if isAuthenticated();
      allow write: if isRCChair();
    }

    // ── Checklists (templates) ──
    match /checklists/{checklistId} {
      allow read: if isAuthenticated();
      allow write: if isRCChair();
    }

    // ── Checklist Completions ──
    match /checklist_completions/{completionId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['web_admin', 'rc_chair']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair'])
        || (isAuthenticated() && resource.data.completedBy == request.auth.uid);
    }

    // ── Maintenance Requests ──
    match /maintenance_requests/{requestId} {
      allow read: if hasAnyRole(['web_admin', 'club_board', 'rc_chair', 'skipper']);
      allow create: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair']);
      allow delete: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Scheduled Maintenance ──
    match /scheduled_maintenance/{docId} {
      allow read: if hasAnyRole(['web_admin', 'club_board', 'rc_chair']);
      allow write: if isRCChair();
    }

    // ── Race Incidents ──
    match /incidents/{incidentId} {
      allow read: if hasAnyRole(['web_admin', 'club_board', 'rc_chair', 'skipper']);
      allow create: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow update, delete: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Boats (Fleet) ──
    match /boats/{boatId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
    }

    // ── Boat Check-ins ──
    match /boat_checkins/{checkinId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
      allow update: if hasAnyRole(['web_admin', 'rc_chair'])
        || (isAuthenticated() && resource.data.checkedInBy == request.auth.uid);
      allow delete: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Weather (live station data — written by Cloud Functions only) ──
    match /weather/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;

      // Station observations subcollection (weather/stations/observations/*)
      match /observations/{stationId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }

    // ── Weather Logs (manual entries) ──
    match /weather_logs/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Fleet Broadcasts ──
    match /fleet_broadcasts/{broadcastId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['web_admin', 'rc_chair']);
      allow delete: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    match /fleetBroadcasts/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ── Timing ──
    match /timing/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Audit Log ──
    match /audit_logs/{logId} {
      allow read: if isBoard();
      allow create: if isAuthenticated();
    }
    match /audit_log/{logId} {
      allow read: if isBoard();
      allow create: if isAuthenticated();
    }

    // ── Reports ──
    match /reports/{reportId} {
      allow read: if isBoard();
      allow write: if isWebAdmin();
    }

    // ── Verification codes: Cloud Functions only ──
    match /verification_codes/{docId} {
      allow read, write: if false;
    }

    // ── Mail queue: Cloud Functions only ──
    match /mail/{docId} {
      allow read, write: if false;
    }

    // ── Sync logs: admin-only reads ──
    match /memberSyncLogs/{docId} {
      allow read: if isWebAdmin();
      allow write: if false;
    }

    // ── Admin notifications: admin-only reads ──
    match /adminNotifications/{docId} {
      allow read: if isWebAdmin();
      allow write: if false;
    }

    // ── SMS logs: admin-only reads ──
    match /smsLogs/{docId} {
      allow read: if isWebAdmin();
      allow write: if false;
    }

    // ── App Settings (System Settings page) ──
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isWebAdmin();
    }

    // ── Wind Groups ──
    match /wind_groups/{docId} {
      allow read: if isAuthenticated();
      allow write: if isRCChair();
    }

    // ── Fleets ──
    match /fleets/{docId} {
      allow read: if isAuthenticated();
      allow write: if isRCChair();
    }

    // ── Fleet Definitions (fleet groups for race management) ──
    match /fleet_definitions/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Race Starts (Timing) ──
    match /race_starts/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Finish Records ──
    match /finish_records/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Handicap Ratings ──
    match /handicap_ratings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isWebAdmin();
    }

    // ── Race Tracks (GPS data from skippers & RC) ──
    match /race_tracks/{trackId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if hasAnyRole(['web_admin', 'rc_chair'])
        || (isAuthenticated() && resource.data.memberId == request.auth.uid);
    }

    // ── Live Race Positions (real-time GPS pings) ──
    match /live_positions/{posId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ── Live Tracks (GPS track points streamed during race) ──
    match /live_tracks/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();

      match /boats/{boatKey} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();

        match /points/{pointId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
      }
    }

    // ── Race State (current race status) ──
    match /race_state/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Crew Assignments ──
    match /crew_assignments/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair', 'skipper']);
    }

    // ── Crew Profiles (keyed by UID) ──
    match /crew_profiles/{userId} {
      allow read: if isAuthenticated();
      allow create, update: if isOwnDocument(userId);
      allow delete: if isWebAdmin();
    }

    // ── Skipper Profiles (keyed by UID) ──
    match /skipper_profiles/{userId} {
      allow read: if isAuthenticated();
      allow create, update: if isOwnDocument(userId);
      allow delete: if isWebAdmin();
    }

    // ── Crew Sign-offs ──
    match /crew_signoffs/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    // ── Notices ──
    match /notices/{docId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['web_admin', 'rc_chair']);
    }

    // ── Default deny ──
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
